<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Passagem de Turno</title>
<style>
body { font-family: Arial, sans-serif; background-color: #fff; color: #333; margin:0; padding:0; }
.container { max-width: 1000px; margin: 40px auto; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; }
h1 { color: #2d6a4f; text-align: center; margin-bottom: 20px; }
form { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom:20px; }
form label { display: block; font-weight: bold; margin-bottom: 4px; }
form input, form textarea { width: 100%; padding: 8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
form textarea { resize: vertical; min-height:60px; }
.full-width { grid-column: 1 / -1; }
button { background-color:#95d5b2; color:#fff; border:none; padding:12px 20px; font-size:16px; cursor:pointer; border-radius:4px; transition: background-color 0.3s; }
button:hover { background-color:#74c69d; }
.history { margin-top:40px; }
.history table { width:100%; border-collapse:collapse; }
.history th, .history td { border:1px solid #ddd; padding:8px; text-align:left; }
.history th { background-color:#e9f5ef; color:#2d6a4f; }
.history tr:nth-child(even) { background-color:#f9f9f9; }
.history tr:hover { background-color:#f1f1f1; }
#watchdogStatus { margin-top: 10px; font-weight: bold; color:#2d6a4f; }
</style>
</head>
<body>
<div class="container">
<h1>Passagem de Turno</h1>

<!-- Login -->
<form id="loginForm" class="full-width">
    <div class="full-width">
        <label for="matriculaLogin">Digite sua Matrícula</label>
        <input type="text" id="matriculaLogin" required/>
    </div>
    <div class="full-width">
        <button type="submit">Login</button>
    </div>
</form>

<!-- Registro de Turno -->
<form id="turnoForm" style="display:none;">
    <div>
        <label for="data">Data / Hora</label>
        <input type="datetime-local" id="data"/>
    </div>
    <div>
        <label for="equipamento">Equipamento</label>
        <input type="text" id="equipamento" required/>
    </div>
    <div>
        <label for="acionamento">Acionamento (Hora)</label>
        <input type="time" id="acionamento" required/>
    </div>
    <div>
        <label for="problema">Problema</label>
        <textarea id="problema" required></textarea>
    </div>
    <div>
        <label for="solucao">Solução</label>
        <textarea id="solucao" required></textarea>
    </div>
    <div>
        <label for="encerramento">Encerramento (Hora)</label>
        <input type="time" id="encerramento" required/>
    </div>
    <div class="full-width">
        <label for="executante">Executante</label>
        <input type="text" id="executante" required/>
    </div>
    <div class="full-width">
        <button type="submit">Registrar Turno</button>
    </div>
</form>

<!-- Botão histórico -->
<div style="margin-top:20px; display:none;" id="btnHistoricoContainer">
    <button id="btnHistorico">Ver Histórico</button>
</div>

<!-- Watchdog -->
<div id="watchdogStatus"></div>

<!-- Histórico -->
<div class="history" id="historyContainer" style="display:none;">
    <h2>Histórico</h2>
    <table id="historyTable">
        <thead>
            <tr>
                <th>Data / Hora</th>
                <th>Equipamento</th>
                <th>Acionamento</th>
                <th>Problema</th>
                <th>Solução</th>
                <th>Encerramento</th>
                <th>Executante</th>
                <th>Data/Hora Edição</th>
                <th>Watchdog</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFS6gRrIGYeWFZ9KYjSaOMLfJd_TTsrZcLNGyvdb7R0RZBcXrQUlgLUdAjNr7B58o/exec";

// --- Funções utilitárias ---
function setDateTime(){
    const now = new Date();
    const formatted = now.toISOString().slice(0,16);
    const dataInput = document.getElementById("data");
    if(!dataInput.value) dataInput.value = formatted;
}

async function postData(payload){
    const resp = await fetch(SCRIPT_URL,{
        method:"POST",
        body: JSON.stringify(payload)
    });
    return resp.json();
}

async function fetchHistory(){
    const resp = await fetch(SCRIPT_URL);
    return resp.json();
}

// --- Watchdog ---
async function checkWatchdog(){
    try{
        const resp = await fetch(SCRIPT_URL+"?watchdog=true");
        const data = await resp.json();
        document.getElementById("watchdogStatus").textContent = `Watchdog: ${data.status.toUpperCase()} | Valor: ${data.valor} | Última atualização: ${data.timestamp}`;
    }catch(err){
        document.getElementById("watchdogStatus").textContent = `Watchdog: ERRO de comunicação`;
    }
}
setInterval(checkWatchdog,10000);
checkWatchdog();

// --- Login ---
document.getElementById("loginForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const matricula = document.getElementById("matriculaLogin").value.trim();
    if(!matricula){ alert("Digite sua matrícula!"); return; }
    try{
        const resp = await postData({login:true,matricula});
        if(resp.success){
            alert("Bem-vindo(a) "+resp.nome);
            document.getElementById("loginForm").style.display="none";
            document.getElementById("turnoForm").style.display="grid";
            document.getElementById("btnHistoricoContainer").style.display="block";
        } else {
            alert(resp.message);
        }
    }catch(err){ console.error(err); alert("Erro ao conectar com o servidor"); }
});

// --- Registro de Turno ---
document.getElementById("turnoForm").addEventListener("submit",async e=>{
    e.preventDefault();
    setDateTime();
    const payload = {
        data: document.getElementById("data").value,
        equipamento: document.getElementById("equipamento").value,
        acionamento: document.getElementById("acionamento").value,
        problema: document.getElementById("problema").value,
        solucao: document.getElementById("solucao").value,
        encerramento: document.getElementById("encerramento").value,
        executante: document.getElementById("executante").value,
        matricula: document.getElementById("matriculaLogin").value
    };
    try{
        const resp = await postData(payload);
        if(resp.success){
            alert("Registro adicionado com sucesso!");
            document.getElementById("turnoForm").reset();
        } else { alert(resp.message); }
    }catch(err){ console.error(err); alert("Erro ao registrar turno"); }
});

// --- Histórico ---
document.getElementById("btnHistorico").addEventListener("click",async ()=>{
    try{
        const hist = await fetchHistory();
        const tbody = document.querySelector("#historyTable tbody");
        tbody.innerHTML="";
        hist.forEach(row=>{
            const tr = document.createElement("tr");
            row.forEach(cell=>{
                const td = document.createElement("td");
                td.textContent = cell;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        document.getElementById("historyContainer").style.display="block";
    }catch(err){ console.error(err); alert("Erro ao buscar histórico"); }
});
</script>

</div>
</body>
</html>
