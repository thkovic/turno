<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Passagem de Turno</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:20px; background:#f7f7f7; }
h1 { color:#2d6a4f; text-align:center; }
form { display:grid; gap:10px; max-width:600px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; }
form input, form textarea { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
button { padding:10px; background:#2d6a4f; color:#fff; border:none; border-radius:4px; cursor:pointer; }
button:hover { background:#1b4332; }
#watchdog { position:absolute; top:10px; right:10px; padding:5px 10px; background:#95d5b2; color:#fff; border-radius:4px; font-weight:bold; }
.history { max-width:1000px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; }
.history table { width:100%; border-collapse:collapse; }
.history th, .history td { border:1px solid #ddd; padding:8px; }
.history th { background:#2d6a4f; color:#fff; }
</style>
</head>
<body>

<div id="watchdog">Watchdog: --</div>

<h1>Sistema Passagem de Turno</h1>

<!-- LOGIN -->
<div style="max-width:400px; margin:0 auto 20px;">
  <input type="text" id="matriculaLogin" placeholder="Digite sua matrícula">
  <button onclick="login()">Login</button>
  <div id="loginMsg" style="margin-top:5px;color:red;"></div>
</div>

<!-- FORMULÁRIO -->
<form id="formTurno" style="display:none;">
  <input type="text" id="nome" placeholder="Nome do operador" readonly>
  <input type="text" id="matricula" placeholder="Matrícula" readonly>
  <input type="text" id="equipamento" placeholder="Equipamento">
  <input type="time" id="acionamento">
  <textarea id="problema" placeholder="Problema"></textarea>
  <textarea id="solucao" placeholder="Solução"></textarea>
  <input type="time" id="encerramento">
  <button type="button" onclick="registrarTurno()">Registrar Turno</button>
  <button type="button" onclick="carregarHistorico()">Histórico</button>
</form>

<!-- HISTÓRICO -->
<div class="history" id="divHistorico" style="display:none;">
  <h2>Histórico de Registros</h2>
  <table>
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Nome</th>
        <th>Matrícula</th>
        <th>Equipamento</th>
        <th>Acionamento</th>
        <th>Problema</th>
        <th>Solução</th>
        <th>Encerramento</th>
        <th>Watchdog</th>
      </tr>
    </thead>
    <tbody id="tbHistorico"></tbody>
  </table>
</div>

<script>
// ================= FUNÇÕES =================

function login() {
  const matricula = document.getElementById("matriculaLogin").value.trim();
  if (!matricula) return;
  google.script.run.withSuccessHandler(res=>{
    if(res.success){
      document.getElementById("loginMsg").textContent = "";
      document.getElementById("formTurno").style.display = "grid";
      document.getElementById("nome").value = res.nome;
      document.getElementById("matricula").value = matricula;
    } else {
      document.getElementById("loginMsg").textContent = res.message;
    }
  }).fazerLogin(matricula);
}

function registrarTurno() {
  const data = {
    acao:"registrar",
    nome: document.getElementById("nome").value,
    matricula: document.getElementById("matricula").value,
    equipamento: document.getElementById("equipamento").value,
    acionamento: document.getElementById("acionamento").value,
    problema: document.getElementById("problema").value,
    solucao: document.getElementById("solucao").value,
    encerramento: document.getElementById("encerramento").value
  };
  google.script.run.withSuccessHandler(res=>{
    alert(res.message);
    carregarHistorico();
  }).processarTurno(data);
}

function carregarHistorico() {
  google.script.run.withSuccessHandler(res=>{
    document.getElementById("divHistorico").style.display="block";
    const tbody = document.getElementById("tbHistorico");
    tbody.innerHTML = "";
    res.forEach(row=>{
      const tr = document.createElement("tr");
      row.forEach(col=>{
        const td = document.createElement("td");
        td.textContent = col;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }).processarTurno({acao:"historico"});
}

// Watchdog automático
setInterval(()=>{
  google.script.run.withSuccessHandler(val=>{
    document.getElementById("watchdog").textContent = "Watchdog: "+val;
  }).atualizarWatchdog();
},5000);
</script>

</body>
</html>
