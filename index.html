<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Passagem de Turno</title>
<style>
  body{font-family:Arial;margin:0;background:#f7f7f7;color:#222}
  .container{max-width:1100px;margin:30px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.08);position:relative}
  h1{text-align:center;color:#2d6a4f}
  form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{font-weight:600;font-size:14px}
  input,textarea,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
  textarea{min-height:80px}
  .full{grid-column:1/-1}
  button{background:#2d6a4f;color:#fff;padding:10px 14px;border:none;border-radius:6px;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:16px;font-size:14px}
  th,td{border:1px solid #e6e6e6;padding:8px;text-align:left}
  th{background:#e9f5ef;color:#2d6a4f}
  #watchdog{position:absolute;top:16px;right:16px;padding:8px 12px;border-radius:6px;background:#52b788;color:#fff;font-weight:700}
  #backLogin{margin-left:10px;background:#888}
</style>
</head>
<body>
  <div class="container">
    <div id="watchdog">Watchdog: --</div>
    <h1>Passagem de Turno</h1>

    <!-- LOGIN -->
    <div id="loginArea">
      <label for="loginMat">Matrícula (login)</label>
      <input id="loginMat" placeholder="Ex: 81057898"/>
      <div style="margin-top:10px;">
        <button id="btnLogin">Entrar</button>
        <button id="btnShowHistoryFromLogin" style="margin-left:8px">Ver Histórico</button>
      </div>
    </div>

    <!-- FORMULÁRIO -->
    <div id="formArea" style="display:none; margin-top:18px">
      <form id="turnoForm">
        <div><label>Tipo</label><input id="tipo" value="Turno"/></div>
        <div><label>Nome (executante)</label><input id="nome" required/></div>
        <div><label>Matrícula</label><input id="matricula" required/></div>
        <div><label>Data / Hora</label><input id="data" type="datetime-local"/></div>
        <div><label>Equipamento</label><input id="equipamento" required/></div>
        <div><label>Acionamento (hora)</label><input id="acionamento" type="time"/></div>
        <div class="full"><label>Problema</label><textarea id="problema" required></textarea></div>
        <div class="full"><label>Solução</label><textarea id="solucao" required></textarea></div>
        <div><label>Encerramento (hora)</label><input id="encerramento" type="time"/></div>
        <div class="full" style="margin-top:8px"><button id="btnRegister">Registrar Turno</button></div>
      </form>
      <div style="margin-top:12px;">
        <button id="btnHistory">Histórico</button>
        <button id="btnLogout" id="backLogin" style="margin-left:8px;background:#888">Sair</button>
      </div>
    </div>

    <!-- HISTÓRICO -->
    <div id="historyArea" style="display:none; margin-top:18px">
      <h2>Histórico</h2>
      <div style="margin-bottom:8px">
        <input id="filterInput" placeholder="Filtrar por texto..." style="width:300px;padding:6px;border-radius:6px;border:1px solid #ccc"/>
        <button id="btnRefresh" style="margin-left:8px">Atualizar</button>
        <button id="btnBack" style="margin-left:8px">Voltar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Tipo</th><th>Nome</th><th>Matrícula</th><th>Data</th><th>Equipamento</th><th>Acionamento</th><th>Problema</th><th>Solução</th><th>Encerramento</th><th>Data/Hora Edição</th><th>Watchdog</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="11" style="text-align:center;padding:16px;color:#666">Nenhum registro carregado</td></tr>
        </tbody>
      </table>
    </div>

  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwFS6gRrIGYeWFZ9KYjSaOMLfJd_TTsrZcLNGyvdb7R0RZBcXrQUlgLUdAjNr7B58o/exec"; // <- substitua pela URL do seu Web App

// Util: envia form-urlencoded (evita preflight CORS)
async function postForm(obj){
  const body = new URLSearchParams();
  for(const k in obj) body.append(k, obj[k]);
  const resp = await fetch(SCRIPT_URL, { method: "POST", body });
  return resp.json();
}

// UTIL: fetch watchdog via GET (action=watchdog)
async function fetchWatchdog(){
  try{
    const resp = await fetch(SCRIPT_URL + "?action=watchdog");
    const j = await resp.json();
    const v = j.valor !== undefined ? j.valor : (j.watchdog !== undefined ? j.watchdog : "--");
    document.getElementById("watchdog").textContent = "Watchdog: " + v;
  }catch(err){
    document.getElementById("watchdog").textContent = "Watchdog: erro";
  }
}

// LOGIN
document.getElementById("btnLogin").addEventListener("click", async ()=>{
  const mat = document.getElementById("loginMat").value.trim();
  if(!mat){ alert("Digite matrícula"); return; }
  const res = await postForm({ acao:"login", matricula: mat });
  if(res.success || res.status === "ok"){
    // se usou retorno {success:true,nome:...} ou {status:"ok"...}
    // se o script retorna nome, preenche
    document.getElementById("formArea").style.display = "block";
    document.getElementById("loginArea").style.display = "none";
    // tenta preencher nome se retornado
    if(res.nome) document.getElementById("nome").value = res.nome;
    document.getElementById("matricula").value = mat;
    // focus
    document.getElementById("nome").focus();
  } else {
    alert(res.message || res);
  }
});

// LOGOUT
document.getElementById("btnLogout").addEventListener("click", ()=>{
  document.getElementById("formArea").style.display = "none";
  document.getElementById("loginArea").style.display = "block";
});

// REGISTRAR
document.getElementById("btnRegister").addEventListener("click", async (ev)=>{
  ev.preventDefault();
  const obj = {
    acao: "registrar",
    tipo: document.getElementById("tipo").value,
    nome: document.getElementById("nome").value,
    matricula: document.getElementById("matricula").value,
    data: document.getElementById("data").value,
    equipamento: document.getElementById("equipamento").value,
    acionamento: document.getElementById("acionamento").value,
    problema: document.getElementById("problema").value,
    solucao: document.getElementById("solucao").value,
    encerramento: document.getElementById("encerramento").value
  };
  const resp = await postForm(obj);
  if(resp.success || resp.status === "ok"){
    alert(resp.message || "Registrado com sucesso");
    // limpa campos, mantém nome e matricula
    document.getElementById("data").value = "";
    document.getElementById("equipamento").value = "";
    document.getElementById("acionamento").value = "";
    document.getElementById("problema").value = "";
    document.getElementById("solucao").value = "";
    document.getElementById("encerramento").value = "";
    // recarrega histórico se estiver visível
    if(document.getElementById("historyArea").style.display === "block") loadHistory();
  } else {
    alert(resp.message || "Erro ao registrar");
  }
});

// CARREGAR HISTÓRICO
async function loadHistory(){
  const btn = document.getElementById("btnRefresh");
  btn.disabled = true;
  btn.textContent = "Carregando...";
  try{
    const resp = await postForm({ acao: "historico" });
    const data = Array.isArray(resp) ? resp : (resp.records || []);
    const tbody = document.getElementById("historyBody");
    tbody.innerHTML = "";
    if(!Array.isArray(data) || data.length === 0){
      tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:16px;color:#666">Nenhum registro encontrado</td></tr>';
    } else {
      // ordenar por data (coluna 3 index 3) — mais recente primeiro
      data.sort((a,b)=>{
        const da = new Date(a[3] || 0).getTime();
        const db = new Date(b[3] || 0).getTime();
        return db - da;
      });
      data.forEach(row=>{
        // row é array com 11 colunas
        const tr = document.createElement("tr");
        for(let i=0;i<11;i++){
          const td = document.createElement("td");
          // formatar a data (col index 3)
          if(i === 3 && row[i]){
            const d = new Date(row[i]);
            if(!isNaN(d.getTime())) td.textContent = d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
            else td.textContent = row[i];
          } else {
            td.textContent = row[i] || "";
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    }
  }catch(err){
    alert("Erro ao carregar histórico: " + err);
  } finally {
    btn.disabled = false;
    btn.textContent = "Atualizar";
  }
}

// show history buttons
document.getElementById("btnHistory").addEventListener("click", ()=>{
  document.getElementById("formArea").style.display = "none";
  document.getElementById("historyArea").style.display = "block";
  loadHistory();
});
document.getElementById("btnShowHistoryFromLogin").addEventListener("click", ()=>{
  document.getElementById("loginArea").style.display = "none";
  document.getElementById("historyArea").style.display = "block";
  loadHistory();
});
document.getElementById("btnBack").addEventListener("click", ()=>{
  document.getElementById("historyArea").style.display = "none";
  document.getElementById("loginArea").style.display = "block";
});

// filtro
document.getElementById("filterInput").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#historyBody tr").forEach(tr=>{
    const txt = tr.innerText.toLowerCase();
    tr.style.display = txt.includes(q) ? "" : "none";
  });
});

// watchdog loop
setInterval(fetchWatchdog, 5000);
fetchWatchdog();
</script>
</body>
</html>
