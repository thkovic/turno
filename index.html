// ================= SISTEMA PASSAGEM DE TURNO - VERS√ÉO ATUALIZADA =================
const SHEET_ID = "1-ItoHJi0JC0CCfXBB6aNGyDws7e6LJxKi8uZPRtLRZY";

// ---------------------- FUN√á√ÉO GET ----------------------
function doGet(e) {
  try {
    // üîÑ HIST√ìRICO VIA GET
    if (e.parameter && e.parameter.getHistory === "true") {
      return ContentService.createTextOutput(JSON.stringify(getHistorico()))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    // üñ• WATCHDOG
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheets()[0];

    let watchdogVal = 0;
    try { 
      watchdogVal = sheet.getRange("Z1").getValue(); 
      if (watchdogVal === "" || isNaN(watchdogVal)) watchdogVal = 0; 
    } catch (err) { sheet.getRange("Z1").setValue(0); }

    const newVal = watchdogVal === 0 ? 1 : 0;
    sheet.getRange("Z1").setValue(newVal);

    return ContentService.createTextOutput(JSON.stringify({
      status: "ok",
      message: "Sistema Passagem de Turno - ONLINE",
      watchdog: newVal,
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);

  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({
      status: "erro",
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ---------------------- FUN√á√ÉO POST ----------------------
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    // üìù REGISTRAR TURNO
    if (data.equipamento || data.nome) {
      const ss = SpreadsheetApp.openById(SHEET_ID);
      const sheet = ss.getSheets()[0];

      const acionamentoFormatado = formatarHoraParaPlanilha(data.acionamento);
      const encerramentoFormatado = formatarHoraParaPlanilha(data.encerramento);

      const idRegistro = "T" + new Date().getTime();
      const row = [
        idRegistro,
        data.nome || "",
        data.matricula || "",
        data.equipamento || "",
        acionamentoFormatado,
        data.problema || "",
        data.solucao || "",
        encerramentoFormatado
      ];

      sheet.appendRow(row);

      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: "Turno registrado com sucesso!",
        id: idRegistro,
        timestamp: new Date().toISOString()
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // üîÑ HIST√ìRICO VIA POST
    if (data.getHistory) {
      return ContentService.createTextOutput(JSON.stringify(getHistorico()))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    // üóëÔ∏è LIMPAR PLANILHA
    if (data.acao === "limparPlanilha") {
      return ContentService.createTextOutput(JSON.stringify(limparERecriarPlanilha()))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    return ContentService.createTextOutput(JSON.stringify({ success: false, message: "A√ß√£o n√£o reconhecida" }))
                         .setMimeType(ContentService.MimeType.JSON);

  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: "Erro: " + error.toString() }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}

// ---------------------- FUN√á√ïES AUXILIARES ----------------------

// Retorna hist√≥rico formatado
function getHistorico() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheets()[0];

  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return [];

  const allData = sheet.getRange(1, 1, lastRow, 8).getValues(); // AGORA S√ÉO 8 COLUNAS
  const registros = [];

  for (let i = 1; i < allData.length; i++) {
    const row = allData[i];
    if (row[3] && row[3].toString().trim() !== "") { // Equipamento agora est√° na coluna 3
      registros.push(row.map((val, idx) => {
        if (idx === 4 || idx === 7) { // Acionamento (4) e Encerramento (7)
          // Acionamento e Encerramento ‚Üí HH:mm
          if (val instanceof Date) {
            return Utilities.formatDate(val, Session.getScriptTimeZone(), "HH:mm");
          } else if (!isNaN(val)) {
            // Valor decimal do Sheets
            const totalMinutos = Math.round(val * 24 * 60);
            const horas = Math.floor(totalMinutos / 60).toString().padStart(2, "0");
            const minutos = (totalMinutos % 60).toString().padStart(2, "0");
            return `${horas}:${minutos}`;
          } else {
            return val;
          }
        } else {
          return val;
        }
      }));
    }
  }

  return registros;
}

// Formata hora para "HH:mm"
function formatarHoraParaPlanilha(horaString) {
  if (!horaString) return "";

  // Se j√° estiver no formato HH:mm
  if (horaString.match(/^\d{2}:\d{2}$/)) return horaString;

  // Se for Date
  if (horaString instanceof Date) {
    return Utilities.formatDate(horaString, Session.getScriptTimeZone(), "HH:mm");
  }

  // Se for n√∫mero decimal do Sheets
  if (!isNaN(horaString)) {
    const totalMinutos = Math.round(horaString * 24 * 60);
    const horas = Math.floor(totalMinutos / 60).toString().padStart(2, "0");
    const minutos = (totalMinutos % 60).toString().padStart(2, "0");
    return `${horas}:${minutos}`;
  }

  // Se tiver T (ISO)
  if (horaString.includes("T")) return horaString.substring(11,16);

  // Tentativa de separar por :
  const parts = horaString.split(":");
  if (parts.length >= 2) return parts[0].padStart(2,"0")+":"+parts[1].padStart(2,"0");

  return horaString;
}

// Limpa e recria planilha com cabe√ßalhos
function limparERecriarPlanilha() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheets()[0];
    sheet.clear();

    const headers = ["ID","Operador","Matr√≠cula","Equipamento","Acionamento","Problema","Solu√ß√£o","Encerramento"]; // 8 COLUNAS
    sheet.getRange(1,1,1,8).setValues([headers]);
    sheet.getRange(1,1,1,8).setBackground("#2d6a4f").setFontColor("white").setFontWeight("bold");

    sheet.getRange("Z1").setValue(0);

    return { success: true, message: "Planilha limpa e recriada com sucesso!", cabecalhos: headers };
  } catch(error) {
    return { success: false, error: error.toString() };
  }
}
