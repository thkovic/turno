<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"/>
<title>Meus Chamados</title>
<style>
body { font-family: Arial; margin:20px; }
input, button { padding:6px; margin:5px; }
table { width:100%; border-collapse:collapse; margin-top:20px;}
th, td { border:1px solid #ddd; padding:8px;}
th { background-color:#e9f5ef; color:#2d6a4f;}
.editBtn { padding:4px 8px; margin-right:4px; cursor:pointer;}
.editBtn:hover { background-color:#2d6a4f; color:#fff;}
</style>
</head>
<body>
<h2>Meus Chamados</h2>
<label for="matriculaFilter">Matrícula:</label>
<input type="text" id="matriculaFilter" placeholder="Digite sua matrícula"/>
<button id="btnBuscar">Buscar</button>

<table id="historyTable">
<thead>
<tr>
<th>Data / Hora Original</th>
<th>Equipamento</th>
<th>Acionamento</th>
<th>Problema</th>
<th>Solução</th>
<th>Encerramento</th>
<th>Executante</th>
<th>Data / Hora Edição</th>
<th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const SCRIPT_URL = "COLE_SEU_SCRIPT_URL_AQUI";

function formatDateTime(dateStr){
  const date = new Date(dateStr);
  const day = String(date.getDate()).padStart(2,'0');
  const month = String(date.getMonth()+1).padStart(2,'0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2,'0');
  const minutes = String(date.getMinutes()).padStart(2,'0');
  return `${day}/${month}/${year} ${hours}:${minutes}`;
}

function formatHour(dateStr){
  const date = new Date(dateStr);
  return String(date.getHours()).padStart(2,'0');
}

async function fetchHistory(){
  const resp = await fetch(SCRIPT_URL);
  const data = await resp.json();
  return data;
}

function renderHistory(data){
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML="";
  data.forEach((row,index)=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${formatDateTime(row[0])}</td>
      <td>${row[1]}</td>
      <td>${formatHour(row[2])}</td>
      <td>${row[3]}</td>
      <td>${row[4]}</td>
      <td>${formatHour(row[5])}</td>
      <td>${row[6]}</td>
      <td>${row[7]?formatDateTime(row[7]):''}</td>
      <td>
        <button class="editBtn" data-index="${index+2}" data-action="editar">Editar</button>
        <button class="editBtn" data-index="${index+2}" data-action="excluir">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

document.getElementById("btnBuscar").addEventListener("click", async ()=>{
  const matricula = document.getElementById("matriculaFilter").value.trim();
  if(!matricula){ alert("Digite a matrícula!"); return; }
  const hist = await fetchHistory();
  const filtrado = hist.filter(row=>row[6].includes(matricula));
  renderHistory(filtrado);
});

document.addEventListener("click", async (e)=>{
  if(e.target.classList.contains("editBtn")){
    const rowIndex = e.target.dataset.index;
    const action = e.target.dataset.action;
    if(action==="excluir"){
      if(confirm("Deseja realmente excluir este chamado?")){
        await fetch(SCRIPT_URL,{method:"DELETE", body:JSON.stringify({rowIndex})});
        document.getElementById("btnBuscar").click();
      }
    }
    if(action==="editar"){
      const tr = e.target.closest("tr");
      const cells = tr.querySelectorAll("td");
      const novoProblema = prompt("Problema:", cells[3].innerText);
      const novaSolucao = prompt("Solução:", cells[4].innerText);
      if(novoProblema!==null && novaSolucao!==null){
        await fetch(SCRIPT_URL,{
          method:"PUT",
          body:JSON.stringify({
            rowIndex,
            data: new Date(cells[0].innerText).toISOString(),
            equipamento: cells[1].innerText,
            acionamento: cells[2].innerText + ":00",
            problema: novoProblema,
            solucao: novaSolucao,
            encerramento: cells[5].innerText + ":00",
            executante: cells[6].innerText
          })
        });
        document.getElementById("btnBuscar").click();
      }
    }
  }
});
</script>
</body>
</html>
